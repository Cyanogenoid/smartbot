#!/usr/bin/env python
import sys
sys.path.append(".")
import argparse
import importlib.machinery
import smartbot
import yaml

def read_storage(config):
    del config["name"]
    return smartbot.storage.YAML(**config)

def read_backend(config):
    del config["name"]
    return smartbot.backend.IRC(**config)

def read_plugin(config):
    name = config["name"]
    del config["name"]
    loader = importlib.machinery.SourceFileLoader("plugins." + name, "plugins/" + name + ".py")
    return loader.load_module("plugins." + name).Plugin(**config)

with open("config.yaml") as fd:
    config = yaml.load(fd.read())

bot = smartbot.Bot()
bot.set_storage(read_storage(config["storage"]))
bot.set_backend(read_backend(config["backend"]))
bot.set_plugins([ read_plugin(x) for x in config["plugins"] ])
bot.run()
